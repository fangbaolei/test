#include <stdio.h>
#include <sys/ioctl.h>
#include <fcntl.h>
#include <stdlib.h>
#include <linux/i2c-dev.h>
#include <linux/i2c.h>
#include <string.h>
#include <ctype.h>
#define CHIP "/dev/i2c-0"
#define CHIP_ADDR 0x44
#define TW9912_REG_END		0xfd
#define TW9912_REG_DELAY    0xfe

struct regval_list {
	unsigned char reg_num;
	unsigned char value;
};

static struct regval_list tw9912_init_regs_640_480[] = 
{
#if 0   // 480p
    {0xFF, 0x00},
    {0x01, 0x78},
    {0x02, 0x44},
    {0x03, 0x20},
    {0x04, 0x00},
    {0x05, 0x1E},
    {0x06, 0x03},
    {0x07, 0x02},
    {0x08, 0x12},
    {0x09, 0xF0},
    {0x0A, 0x14},
    {0x0B, 0xD0},
    {0x0C, 0xCC},
    {0x0D, 0x15},
    {0x10, 0x00},
    {0x11, 0x64},
    {0x12, 0x11},
    {0x13, 0x80},
    {0x14, 0x80},
    {0x15, 0x00},
    {0x17, 0x30},
    {0x18, 0x44},
    {0x1A, 0x10},
    {0x1B, 0x00},
    {0x1C, 0x07},
    {0x1D, 0x7F},
    {0x1E, 0x08},
    {0x1F, 0x00},
    {0x20, 0x50},
    {0x21, 0x42},
    {0x22, 0xF0},
    {0x23, 0xD8},
    {0x24, 0xBC},
    {0x25, 0xB8},
    {0x26, 0x44},
    {0x27, 0x38},
    {0x28, 0x00},
    {0x29, 0x00},
    {0x2A, 0x78},
    {0x2B, 0x44},
    {0x2C, 0x30},
    {0x2D, 0x14},
    {0x2E, 0xA5},
    {0x2F, 0x26},
    {0x30, 0x00},
    {0x31, 0x10},
    {0x32, 0xFF},
    {0x33, 0x05},
    {0x34, 0x1A},
    {0x35, 0x00},
    {0x36, 0xE2},
    {0x37, 0x2D},
    {0x38, 0x01},
    {0x40, 0x00},
    {0x41, 0x80},
    {0x42, 0x00},
    {0xC0, 0x01},
    {0xC1, 0x07},
    {0xC2, 0x01},
    {0xC3, 0x03},
    {0xC4, 0x5A},
    {0xC5, 0x00},
    {0xC6, 0x20},
    {0xC7, 0x04},
    {0xC8, 0x00},
    {0xC9, 0x06},
    {0xCA, 0x06},
    {0xCB, 0x30},
    {0xCC, 0x00},
    {0xCD, 0x54},
    {0xD0, 0x00},
    {0xD1, 0xF0},
    {0xD2, 0xF0},
    {0xD3, 0xF0},
    {0xD4, 0x00},
    {0xD5, 0x00},
    {0xD6, 0x10},
    {0xD7, 0x70},
    {0xD8, 0x00},
    {0xD9, 0x04},
    {0xDA, 0x80},
    {0xDB, 0x80},
    {0xDC, 0x20},
    {0xE0, 0x00},
    {0xE1, 0x49},
    {0xE2, 0x01},
    {0xE3, 0x00},
    {0xE4, 0x00},
    {0xE5, 0x00},
    {0xE6, 0x00},
    {0xE7, 0x2A},
    {0xE8, 0x0F},
    {0xE9, 0x61},
    {TW9912_REG_END, 0x00},	/* END MARKER */
#else   //576p
    {0xFF, 0x00},
    {0x01, 0x78},
    {0x02, 0x44},
    {0x03, 0x20},
    {0x04, 0x00},
    {0x05, 0x1E},
    {0x06, 0x03},
    {0x07, 0x12},   // hi 0x10 h v active
    {0x08, 0x12},
    {0x09, 0x20},   // low v active regester
    {0x0A, 0x14},
    {0x0B, 0xD0}, 
    {0x0C, 0xCC},
    {0x0D, 0x15},
    {0x10, 0x00},
    {0x11, 0x64},
    {0x12, 0x11},
    {0x13, 0x80},
    {0x14, 0x80},
    {0x15, 0x00},
    {0x17, 0x30},
    {0x18, 0x44},
    {0x1A, 0x10},
    {0x1B, 0x00},
    {0x1C, 0x07},
    {0x1D, 0x7F},
    {0x1E, 0x08},
    {0x1F, 0x00},
    {0x20, 0x50},
    {0x21, 0x42},
    {0x22, 0xF0},
    {0x23, 0xD8},
    {0x24, 0xBC},
    {0x25, 0xB8},
    {0x26, 0x44},
    {0x27, 0x38},
    {0x28, 0x00},
    {0x29, 0x00},
    {0x2A, 0x78},
    {0x2B, 0x44},
    {0x2C, 0x30},
    {0x2D, 0x14},
    {0x2E, 0xA5},
    {0x2F, 0x26},
    {0x30, 0x00},
    {0x31, 0x10},
    {0x32, 0xFF},
    {0x33, 0x05},
    {0x34, 0x1A},
    {0x35, 0x00},
    {0x36, 0xE2},
    {0x37, 0x2D},
    {0x38, 0x01},
    {0x40, 0x00},
    {0x41, 0x80},
    {0x42, 0x00},
    {0xC0, 0x01},
    {0xC1, 0x02},
    {0xC2, 0x01},
    {0xC3, 0x03},
    {0xC4, 0x5A},
    {0xC5, 0x00},
    {0xC6, 0x20},
    {0xC7, 0x04},
    {0xC8, 0x00},
    {0xC9, 0x06},
    {0xCA, 0x06},
    {0xCB, 0x30},
    {0xCC, 0x00},
    {0xCD, 0x54},
    {0xD0, 0x00},
    {0xD1, 0xF0},
    {0xD2, 0xF0},
    {0xD3, 0xF0},
    {0xD4, 0x00},
    {0xD5, 0x00},
    {0xD6, 0x10},
    {0xD7, 0x70},
    {0xD8, 0x00},
    {0xD9, 0x04},
    {0xDA, 0x80},
    {0xDB, 0x80},
    {0xDC, 0x20},
    {0xE0, 0x00},
    {0xE1, 0x49},
    {0xE2, 0x01},
    {0xE3, 0x00},
    {0xE4, 0x00},
    {0xE5, 0x00},
    {0xE6, 0x00},
    {0xE7, 0x2A},
    {0xE8, 0x0F},
    {0xE9, 0x61},
    {TW9912_REG_END, 0x00},	/* END MARKER */
#endif
};
int read(int fd,unsigned char reg,unsigned char* data)
{
    int ret;
    struct i2c_rdwr_ioctl_data ioctl_data;
    struct i2c_msg msgs[2] = {
        [0] = {
            .addr   = CHIP_ADDR,
            .flags  = 0,         // write
            .len    = 1,
            .buf    = &reg,
        },
        [1] = {
            .addr   = CHIP_ADDR,
            .flags  = I2C_M_RD,
            .len    = 1,
            .buf    = data,
        }
    };
    ioctl_data.nmsgs= 2;
    ioctl_data.msgs= &msgs[0];
    if((ret=ioctl(fd, I2C_RDWR, &ioctl_data))<0)
         printf("ioctl write address,return :%d/n",ret);
    printf("read 0x%02x data=0x%02x\n",reg,*data);
    return 0;
}

int write(int fd,unsigned char reg,unsigned char data)
{
  	int ret;
    struct i2c_rdwr_ioctl_data ioctl_data;    
	unsigned char buf[2] = {reg, data};
	struct i2c_msg msgs = {
		.addr	= CHIP_ADDR,
		.flags	= 0,
		.len	= 2,
		.buf	= buf,
	};
    ioctl_data.nmsgs= 1;
    ioctl_data.msgs= &msgs;
    if((ret=ioctl(fd, I2C_RDWR, &ioctl_data))<0)
        printf("ioctl write data,return :%d/n",ret);
    return 0;    
}

static int write_array(int fd , struct regval_list *vals)
{
	int ret;
	while (vals->reg_num != TW9912_REG_END) {
		if (vals->reg_num == TW9912_REG_DELAY) {
				usleep(vals->value*1000);
		} else {
			ret = write(fd, vals->reg_num, vals->value);
            printf("reg=%2x,value=%2x\n",vals->reg_num,vals->value);
			if (ret < 0)
				return ret;
		}
		vals++;
	}
	return 0;
}


void help()
{
    printf("-r reg\n");
    printf("-w reg value\n");
}

int main(int argc,char *argv[])
{
    int fd =open(CHIP, O_RDWR);
    if (fd< 0) {
        printf("open %s failed\n",CHIP);
        exit(-1);
    }
    write_array(fd,&tw9912_init_regs_640_480[0]);
    close(fd);
    return 0;
}
